# Tooling

## ds-to-dhall

During the transition period from the existing YAML manifests to the new Dhall pipeline there is a need
to bring the existing YAML manifests into the Dhall Sourcegraph deployment world. This need comes from the desire
to compare/diff existing manifests with the manifests generated by the Dhall pipeline. It also is useful to
compare different YAML bases in the Dhall world because Dhall diffs ignore semantically insignificant diffs. This allows
us to collect all the customizations necessary to get from one manifest base to another.

To convert yaml to Dhall we use a wrapper helper tool around the standard `yaml-to-dhall` command that knows how to build the
COMKIR organizational tree (see [Background: COMKIR](background.md#COMKIR)). The wrapper is a
command line tool written in Go and available in this repo: `github.com/sourcegraph/ds-to-dhall` (named such that `ds` stands for `deploy-sourcegraph`)

![ds-to-dhall](imgs/ds-to-dhall.png?raw=true 'ds-to-dhall')

We can use it to convert for example `deploy-sourcegraph/base` like so:

```shell
ds-to-dhall ds2dhall -i kustomization.yaml -o base.dhall ~/work/src/github.com/sourcegraph/deploy-sourcegraph/base
```

This will create a dhall file `base.dhall` with a record of all the components with all their Kubernetes resources
organized as described above.

To get to an individual Kubernetes resource like the frontend deployment we can just navigate this organizational
tree to that specific subfield:

```shell
echo '(./base.dhall).Frontend.Deployment.sourcegraph-frontend' | dhall-to-yaml
```

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  annotations:
    description: 'Serves the frontend of Sourcegraph via HTTP(S).'
  labels:
    app.kubernetes.io/component: frontend
    deploy: sourcegraph
    sourcegraph-resource-requires: no-cluster-admin
  name: sourcegraph-frontend
spec: ....
```

Let's generate a Dhall record for `deploy-sourcegraph-some-other-deployment/base` also and then compare them for one specific
component.

```shell
ds-to-dhall ds2dhall -i kustomization.yaml -o other-deployment.dhall ~/work/src/github.com/sourcegraph/deploy-sourcegraph-some-other-deployment
```

We can now invoke Dhall diff to determine what customizations on top of `deploy-sourcegraph/base` are needed
to generate `deploy-sourcegraph-some-other-deployment/base`:

```shell
dhall diff '(./base.dhall).Symbols' '(./other-deployment.dhall).Symbols'
```

```dhall
{ Deployment = { symbols = { metadata = { annotations = Some
                                                        [ …
                                                        , + { mapKey =
                                                                "sidecar.jaegertracing.io/inject"
                                                            , mapValue = "true"
                                                            }
                                                        ]

                                        , labels = Some
                                                   [ - { mapKey =
                                                           "app.kubernetes.io/component"
                                                       , mapValue = "symbols"
                                                       }
                                                   , …
                                                   ]

                                        , namespace = - None …
                                                      + Some …
                                        , …
                                        }
                           , spec = Some
                                    { replicas = Some
                                                 - 1
                                                 + 4
                                    , template = { metadata = { labels = Some
                                                                         [ …
                                                                         , + { mapKey =
                                                                                 "purpose"
                                                                             , mapValue =
                                                                                 "vertical-pod-autoscaler-try-recommend"
                                                                             }
                                                                         ]

                                                              , …
                                                              }
```

The command `dhall diff` takes as arguments two Dhall expressions and compares them. The diff that it outputs reads similar
to git diff: it shows what needs to change to turn the left expression into the right expression: differences prefixed
with a `-` denote deletion, differences prefixed with `+` denote addition and other differences are value edits.

For example in the dhall diff output above the replicas field needs to replace the '1' with a '4' to get to the some-other-deployment
subfield value.

## dhall-to-ds

The Dhall Sourcegraph deployment pipeline generates an aggregated output shape record
(see [Background: Pipeline and Aggregate records](background.md#pipeline-and-aggregate-records) for details). To get back to individual YAML Kubernetes
files that `kubectl` can consume, we need a tool that walks the output tree and generates the individual files giving
them appropriate filenames and placing them in the appropriate component output directories.

## dhall-docker-img

[dhall-docker-img](https://github.com/sourcegraph/dhall-docker-img)
